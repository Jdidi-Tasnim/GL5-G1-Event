stage('TERRAFORM DESTROY') {
    when {
        expression { 
            return params.TERRAFORM_ACTION == 'destroy'
        }
    }
    steps {
        script {
            withCredentials([
                string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
                string(credentialsId: 'aws-session-token', variable: 'AWS_SESSION_TOKEN')
            ]) {
                dir("${PROJECT_DIR}/terraform") {
                    sh '''
                        # Configure AWS credentials
                        export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
                        export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
                        export AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
                        
                        echo "=== TERRAFORM DESTROY ==="
                        echo "[WARNING] WARNING: This will destroy all infrastructure managed by Terraform"
                        
                        # Check if state file exists
                        if [ -f terraform.tfstate ] && [ -s terraform.tfstate ]; then
                            echo "State file found. Resources to destroy:"
                            terraform state list
                            
                            echo ""
                            echo "Destroying infrastructure..."
                            terraform destroy -auto-approve
                            
                            echo "[SUCCESS] Infrastructure destroyed successfully"
                        else
                            echo "[WARNING] No Terraform state file found - nothing to destroy"
                        fi
                    '''
                }
            }
        }
    }
}